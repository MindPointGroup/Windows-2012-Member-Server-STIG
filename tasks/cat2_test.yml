- name: "MEDIUM | V-1097 | AUDIT | The system must lockout accounts after 3 invalid logon attempts within a specified time period."
  win_shell: net accounts | select-string -Pattern "threshold"
  register: lockout_threshold_audit
  check_mode: no
  changed_when: no
  tags:
      - cat2
      - medium
      - audit
      - V-1097

- name: "MEDIUM | V-1097 | PATCH | The system must lockout accounts after 3 invalid logon attempts within a specified time period."
  win_shell: net accounts /lockoutthreshold:5
  when: "'5' not in lockout_threshold_audit.stdout"
  tags:
      - cat2
      - medium
      - patch
      - V-1097

- name: "MEDIUM | V-1099 | AUDIT | The account lockout duration must be configured to require an administrator to unlock an account."
  debug: var=secedit_rules.System_Access.LockoutDuration
  check_mode: no
  changed_when: no
  tags:
      - cat2
      - medium
      - audit
      - V-1099

#- name: "MEDIUM | V-1099 | PATCH | The account lockout duration must be configured to require an administrator to unlock an account."
#  win_secedit: 
#      category: 'System Access'
#      key: LockoutDuration
#      value: -1
#  register: secedit
#  failed_when: "secedit.failed is defined and 'This host is joined to a Domain Controller' not in secedit.msg"
#  tags:
#      - cat2
#      - medium
#      - patch
#      - V-1099

- name: "MEDIUM | V-1104 | AUDIT | The maximum password age must be configured to 60 days or less."
  win_shell: net accounts | Select-String -Pattern "Max"
  register: max_password_age_audit
  check_mode: no
  changed_when: no
  tags:
      - cat2
      - medium
      - audit
      - V-1104

- name: "MEDIUM | V-1104 | PATCH | The maximum password age must be configured to 60 days or less."
  win_command: net accounts /maxpwage:60
  when: "'60' not in max_password_age_audit.stdout"
  tags:
      - cat2
      - medium
      - patch
      - V-1104

- name: "MEDIUM | V-1105 | AUDIT | The minimum password age must be configured to at least 1 day."
  debug: var=secedit_rules.System_Access.MinimumPasswordAge
  check_mode: no
  changed_when: no
  tags:
      - cat2
      - medium
      - audit
      - V-1105

#- name: "MEDIUM | V-1105 | PATCH | The minimum password age must be configured to at least 1 day."
#  win_command: net accounts /minpwage:0
#  when: secedit_rules.System_Access.MinimumPasswordAge != "0"
#  tags:
#      - cat2
#      - medium
#      - patch
#      - V-1105

- name: "MEDIUM | V-1107 | AUDIT | The password history must be configured to 24 passwords remembered."
  debug: var=secedit_rules.System_Access.PasswordHistorySize
  check_mode: no
  changed_when: no
  tags:
      - cat2
      - medium
      - audit
      - V-1107

#- name: "MEDIUM | V-1107 | PATCH | The password history must be configured to 24 passwords remembered."
#  win_secedit:
#      category: 'System Access'
#      key: PasswordHistorySize
#      value: '12'
#  register: secedit
#  failed_when: "secedit.failed is defined and 'This host is joined to a Domain Controller' not in secedit.msg"
#  tags:
#      - cat2
#      - medium
#      - patch
#      - V-1107

- name: "MEDIUM | V-1113 | AUDIT | The built-in guest account must be disabled."
  debug: var=secedit_rules.System_Access.EnableGuestAccount
  check_mode: no
  changed_when: no
  tags:
      - cat2
      - medium
      - audit
      - V-1113

#- name: "MEDIUM | V-1113 | PATCH | The built-in guest account must be disabled."
#  win_secedit:
#      category: 'System Access'
#      key: EnableGuestAccount
#      value: '0'
#  register: secedit
#  failed_when: "secedit.failed is defined and 'This host is joined to a Domain Controller' not in secedit.msg"
#  tags:
#      - cat2
#      - medium
#      - patch
#      - V-1113

- name: "MEDIUM | V-1119 | AUDIT | Booting into alternate non STIG compliant operating systems will not be permitted."
  win_command: bcdedit
  register: OS_list_audit
  check_mode: no
  changed_when: no
  tags:
      - cat2
      - medium
      - audit
      - V-1119

- name: "MEDIUM | V-1141 | AUDIT | Unencrypted passwords must not be sent to third-party SMB Servers."
  win_command: reg query HKLM\SYSTEM\CurrentControlSet\Services\LanmanWorkstation\Parameters /v EnablePlainTextPassword
  register: plain_text_password_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in plain_text_password_audit.stderr and plain_text_password_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-1141

- name: "MEDIUM | V-1141 | PATCH | Unencrypted passwords must not be sent to third-party SMB Servers."
  win_regedit:
      key: 'HKLM:\SYSTEM\CurrentControlSet\Services\LanmanWorkstation\Parameters'
      value: EnablePlainTextPassword
      data: 0
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-1141

- name: "MEDIUM | V-1145 | AUDIT | Automatic logons must be disabled."
  win_command: reg query \"HKLM\Software\Microsoft\Windows NT\CurrentVersion\Winlogon\" /v AutoAdminLogon
  register: disable_automatic_logons_audit
  check_mode: no
  changed_when: no
  ignore_errors: yes
  failed_when: "reg_not_found not in disable_automatic_logons_audit.stderr and disable_automatic_logons_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-1145

- name: "MEDIUM | V-1145 | PATCH | Automatic logons must be disabled."
  win_regedit:
    key: 'HKLM:\Software\Microsoft\Windows NT\CurrentVersion\Winlogon'
    value: AutoAdminLogon
    data: 0
  tags:
      - cat2
      - medium
      - patch
      - V-1145

- name: "MEDIUM | V-1150 | AUDIT | The built-in Windows password complexity policy must be enabled."
  debug: var=secedit_rules.System_Access.PasswordComplexity
  check_mode: no
  changed_when: no
  tags:
      - cat2
      - medium
      - audit
      - V-1150

#- name: "MEDIUM | V-1150 | PATCH | The built-in Windows password complexity policy must be enabled."
#  win_secedit:
#      category: 'System Access'
#      key: PasswordComplexity
#      value: '1'
#  register: secedit
#  failed_when: "secedit.failed is defined and 'This host is joined to a Domain Controller' not in secedit.msg"
#  tags:
#      - cat2
#      - medium
#      - patch
#      - V-1150

- name: "MEDIUM | V-1154 | AUDIT | The Ctrl+Alt+Del security attention sequence for logons will be enabled."
  win_command: reg query HKLM\Software\Microsoft\Windows\CurrentVersion\Policies\System /v DisableCAD
  register: disable_CAD_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in disable_CAD_audit.stderr and disable_CAD_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-1154

- name: "MEDIUM | V-1154 | PATCH | The Ctrl+Alt+Del security attention sequence for logons will be enabled."
  win_regedit: 
      key: 'HKLM:\Software\Microsoft\Windows\CurrentVersion\Policies\System'
      value: DisableCAD
      data: 0
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-1154

- name: "MEDIUM | V-1162 | AUDIT | The Windows SMB server will perform SMB packet signing when possible."
  win_command: reg query HKLM\System\CurrentControlSet\Services\LanManServer\Parameters /v EnableSecuritySignature
  register: SMB_server_packet_signing_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in SMB_server_packet_signing_audit.stderr and SMB_server_packet_signing_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-1162

- name: "MEDIUM | V-1163 | AUDIT | Outgoing secure channel traffic will be encrypted when possible."
  win_command: reg query HKLM\System\CurrentControlSet\Services\Netlogon\Parameters /v SealSecureChannel
  register: encrypt_outgoing_secure_channel_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in encrypt_outgoing_secure_channel_audit.stderr and encrypt_outgoing_secure_channel_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-1163

- name: "MEDIUM | V-1163 | PATCH | Outgoing secure channel traffic will be encrypted when possible."
  win_regedit:
      key: 'HKLM:\System\CurrentControlSet\Services\Netlogon\Parameters'
      value: SealSecureChannel
      data: 1
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-1163

- name: "MEDIUM | V-1164 | AUDIT | Outgoing secure channel traffic will be signed when possible."
  win_command: reg query HKLM\System\CurrentControlSet\Services\Netlogon\Parameters /v SignSecureChannel
  register: sign_outgoing_secure_channel_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in sign_outgoing_secure_channel_audit.stderr and sign_outgoing_secure_channel_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-1164

- name: "MEDIUM | V-1164 | PATCH | Outgoing secure channel traffic will be signed when possible."
  win_regedit:
      key: 'HKLM:\System\CurrentControlSet\Services\Netlogon\Parameters'
      value: SignSecureChannel
      data: 1
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-1164

- name: "MEDIUM | V-1166 | AUDIT | The Windows SMB client will be enabled to perform SMB packet signing when possible."
  win_command: reg query HKLM\System\CurrentControlSet\Services\LanmanWorkstation\Parameters /v EnableSecuritySignature
  register: SMB_client_packet_signing_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in SMB_client_packet_signing_audit.stderr and SMB_client_packet_signing_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-1166

- name: "MEDIUM | V-1171 | AUDIT | Ejection of removable NTFS media is not restricted to Administrators."
  win_command: reg query \"HKLM\Software\Microsoft\Windows NT\CurrentVersion\Winlogon\" /v AllocateDASD
  register: eject_removable_media_audit
  check_mode: no
  changed_when: no
  ignore_errors: yes
  failed_when: "reg_not_found not in eject_removable_media_audit.stderr and eject_removable_media_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-1171

- name: "MEDIUM | V-1171 | PATCH | Ejection of removable NTFS media is not restricted to Administrators."
  win_regedit:
      key: 'HKLM:\Software\Microsoft\Windows NT\CurrentVersion\Winlogon'
      value: AllocateDASD
      data: 0
  ignore_errors: yes
  tags:
      - cat2
      - medium
      - patch
      - V-1171

- name: "MEDIUM | V-3245 | AUDIT | File share ACLs will be reconfigured to remove the Everyone group."
  win_shell:  Get-WmiObject -Class Win32_Share | Get-Acl | fl
  register: eject_removable_media_audit
  check_mode: no
  changed_when: no
  failed_when: "path_is_null not in eject_removable_media_audit.stderr and eject_removable_media_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-3245

- name: "MEDIUM | V-3374 | AUDIT | The system must be configured to require a strong session key."
  win_command: reg query HKLM\System\CurrentControlSet\Services\Netlogon\Parameters\ /v RequireStrongKey
  register: strong_sessionkey_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in strong_sessionkey_audit.stderr and strong_sessionkey_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-3374

- name: "MEDIUM | V-3374 | PATCH | The system must be configured to require a strong session key."
  win_regedit:
      key: 'HKLM:\System\CurrentControlSet\Services\Netlogon\Parameters\'
      value: RequireStrongKey
      data: 1
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-3374

- name: "MEDIUM | V-3376 | AUDIT | The system will be configured to prevent the storage of passwords and credentials"
  win_command: reg query HKLM\System\CurrentControlSet\Control\Lsa /v DisableDomainCreds
  register: creds_storage_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in creds_storage_audit.stderr and creds_storage_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-3376

- name: "MEDIUM | V-3376 | PATCH | The system will be configured to prevent the storage of passwords and credentials"
  win_regedit:
      key: 'HKLM:\System\CurrentControlSet\Control\Lsa'
      value: DisableDomainCreds
      data: 1
      datatype: dword
      tags:
          - cat2
          - medium
          - patch
          - V-3376

- name: "MEDIUM | V-3377 | AUDIT | The system will be configured to prevent anonymous users from having the same rights as the Everyone group."
  win_command: reg query HKLM\System\CurrentControlSet\Control\Lsa /v EveryoneIncludesAnonymous
  register: everyone_includes_anon_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in everyone_includes_anon_audit.stderr and everyone_includes_anon_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-3377

- name: "MEDIUM | V-3377 | PATCH | The system will be configured to prevent anonymous users from having the same rights as the Everyone group."
  win_regedit:
      key: 'HKLM:\System\CurrentControlSet\Control\Lsa'
      value: EveryoneIncludesAnonymous
      data: 0
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-3377

- name: "MEDIUM | V-3378 | AUDIT | The system will be configured to use the Classic security model."
  win_command: reg query HKLM\System\CurrentControlSet\Control\Lsa /v ForceGuest
  register: classic_security_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in classic_security_audit.stderr and classic_security_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-3378

- name: "MEDIUM | V-3378 | PATCH | The system will be configured to use the Classic security model."
  win_regedit:
      key: 'HKLM:\System\CurrentControlSet\Control\Lsa'
      value: ForceGuest
      data: 0
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-3378

- name: "MEDIUM | V-3381 | AUDIT | The system will be configured to the required LDAP client signing level."
  win_command: reg query HKLM\System\CurrentControlSet\Services\LDAP /v LDAPClientIntegrity
  register: LDAP_client_integrity_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in LDAP_client_integrity_audit.stderr and LDAP_client_integrity_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-3381

- name: "MEDIUM | V-3381 | PATCH | The system will be configured to the required LDAP client signing level."
  win_regedit:
      key: 'HKLM:\System\CurrentControlSet\Services\LDAP'
      value: LDAPClientIntegrity
      data: 1
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-3381

- name: "MEDIUM | V-3382 | AUDIT | The system will be configured to meet the minimum session security requirement for NTLM SSP based clients."
  win_command: reg query HKLM\System\CurrentControlSet\Control\Lsa\MSV1_0 /v NTLMMinClientSec
  register: NTLM_min_client_sec_audit
  check_mode: no
  changed_when: "'0x20080000' not in NTLM_min_client_sec_audit.stdout"
  failed_when: "reg_not_found not in NTLM_min_client_sec_audit.stderr and NTLM_min_client_sec_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-3382

- name: "MEDIUM | V-3382 | PATCH | The system will be configured to meet the minimum session security requirement for NTLM SSP based clients."
  win_regedit:
      key: 'HKLM:\System\CurrentControlSet\Control\Lsa\MSV1_0'
      value: NTLMMinClientSec
      data: 0x20080000
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-3382

- name: "MEDIUM | V-3385 | AUDIT | The system must be configured to require case insensitivity for non-Windows subsystems."
  win_command: reg query \"HKLM\System\CurrentControlSet\Control\Session Manager\Kernel\" /v ObCaseInsensitive
  register: case_insensitive_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in case_insensitive_audit.stderr and case_insensitive_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-3385

- name: "MEDIUM | V-3385 | PATCH | The system must be configured to require case insensitivity for non-Windows subsystems."
  win_regedit:
      key: 'HKLM:\System\CurrentControlSet\Control\Session Manager\Kernel'
      value: ObCaseInsensitive
      data: 1
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-3385

- name: "MEDIUM | V-3449 | AUDIT | Remote Desktop Services will limit users to one remote session."
  win_command: reg query \"HKLM\Software\Policies\Microsoft\Windows NT\Terminal Services\" /v fSingleSessionPerUser
  register: single_rdp_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in single_rdp_audit.stderr and single_rdp_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-3449

- name: "MEDIUM | V-3449 | PATCH | Remote Desktop Services will limit users to one remote session."
  win_regedit:
      key: 'HKLM:\Software\Policies\Microsoft\Windows NT\Terminal Services'
      value: fSingleSessionPerUser
      data: 1
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-3449

- name: "MEDIUM | V-3453 | AUDIT | Remote Desktop Services will always prompt a client for passwords upon connection."
  win_command: reg query \"HKLM\Software\Policies\Microsoft\Windows NT\Terminal Services\" /v fPromptForPassword
  register: rdp_password_prompt_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in rdp_password_prompt_audit.stderr and rdp_password_prompt_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-3453

- name: "MEDIUM | V-3453 | PATCH | Remote Desktop Services will always prompt a client for passwords upon connection."
  win_regedit:
      key: 'HKLM:\Software\Policies\Microsoft\Windows NT\Terminal Services'
      value: fPromptForPassword
      data: 1
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-3453

- name: "MEDIUM | V-3454 | AUDIT | Remote Desktop Services will be configured with the client connection encryption set to the required level."
  win_command: reg query \"HKLM\Software\Policies\Microsoft\Windows NT\Terminal Services\" /v MinEncryptionLevel
  register: min_encrypt_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in min_encrypt_audit.stderr and min_encrypt_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-3454

- name: "MEDIUM | V-3455 | AUDIT | Remote Desktop Services will be configured to use session-specific temporary folders."
  win_command: reg query \"HKLM\Software\Policies\Microsoft\Windows NT\Terminal Services\" /v PerSessionTempDir
  register: temp_folder_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in temp_folder_audit.stderr and temp_folder_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-3455

- name: "MEDIUM | V-3455 | PATCH | Remote Desktop Services will be configured to use session-specific temporary folders."
  win_regedit:
      key: 'HKLM:\Software\Policies\Microsoft\Windows NT\Terminal Services'
      value: PerSessionTempDir
      data: 1
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-3455

- name: "MEDIUM | V-3456 | AUDIT | Remote Desktop Services will delete temporary folders when a session is terminated."
  win_command: reg query \"HKLM\Software\Policies\Microsoft\Windows NT\Terminal Services\" /v DeleteTempDirsOnExit
  register: delete_temp_folder_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in delete_temp_folder_audit.stderr and delete_temp_folder_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-3456

- name: "MEDIUM | V-3456 | PATCH | Remote Desktop Services will delete temporary folders when a session is terminated."
  win_regedit:
      key: 'HKLM:\Software\Policies\Microsoft\Windows NT\Terminal Services'
      value: DeleteTempDirsOnExit
      data: 1
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-3456

- name: "MEDIUM | V-3457 | AUDIT | Remote Desktop Services will be configured to set a time limit for disconnected sessions."
  win_command: reg query \"HKLM\Software\Policies\Microsoft\Windows NT\Terminal Services\" /v MaxDisconnectionTime
  register: max_disconnection_time_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in max_disconnection_time_audit.stderr and max_disconnection_time_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-3457

- name: "MEDIUM | V-3457 | PATCH | Remote Desktop Services will be configured to set a time limit for disconnected sessions."
  win_regedit:
      key: 'HKLM:\Software\Policies\Microsoft\Windows NT\Terminal Services'
      value: MaxDisconnectionTime
      data: 0x0000ea60
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-3457

- name: "MEDIUM | V-3458 | AUDIT | Remote Desktop Services will be configured to disconnect an idle session after the specified time period."
  win_command: reg query \"HKLM\Software\Policies\Microsoft\Windows NT\Terminal Services\" /v MaxIdleTime
  register: max_idle_time_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in max_idle_time_audit.stderr and max_idle_time_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-3458

- name: "MEDIUM | V-3458 | PATCH | Remote Desktop Services will be configured to disconnect an idle session after the specified time period."
  win_regedit:
      key: 'HKLM:\Software\Policies\Microsoft\Windows NT\Terminal Services'
      value: MaxIdleTime
      data: 0x000dbba0
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-3458

- name: "MEDIUM | V-3469 | AUDIT | The system will be configured to enable the background refresh of Group Policy."
  win_command: reg query HKLM\Software\Microsoft\Windows\CurrentVersion\Policies\system /v DisableBkGndGroupPolicy
  register: background_group_policy_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in background_group_policy_audit.stderr and background_group_policy_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-3469

- name: "MEDIUM | V-3469 | PATCH | The system will be configured to enable the background refresh of Group Policy."
  win_regedit:
      key: 'HKLM:\Software\Microsoft\Windows\CurrentVersion\Policies\system'
      value: DisableBkGndGroupPolicy
      data: 0
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-3469

- name: "MEDIUM | V-3470 | AUDIT | The system will be configured to prevent unsolicited remote assistance offers."
  win_command: reg query \"HKLM\Software\Policies\Microsoft\Windows NT\Terminal Services\" /v fAllowUnsolicited
  register: unsolicited_remote_assistance_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in unsolicited_remote_assistance_audit.stderr and unsolicited_remote_assistance_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-3470

- name: "MEDIUM | V-3470 | PATCH | The system will be configured to prevent unsolicited remote assistance offers."
  win_regedit:
      key: 'HKLM:\Software\Policies\Microsoft\Windows NT\Terminal Services'
      value: fAllowUnsolicited
      data: 0
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-3470

- name: "MEDIUM | V-3479 | AUDIT | The system will be configured to use Safe DLL Search Mode."
  win_command: reg query \"HKLM\System\CurrentControlSet\Control\Session Manager\" /v SafeDllSearchMode
  register: safe_DLL_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in safe_DLL_audit.stderr and safe_DLL_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-3479

- name: "MEDIUM | V-3479 | PATCH | The system will be configured to use Safe DLL Search Mode."
  win_regedit:
      key: 'HKLM:\System\CurrentControlSet\Control\Session Manager'
      value: SafeDllSearchMode
      data: 1
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-3479

- name: "MEDIUM | V-3480 | AUDIT | Media Player must be configured to prevent automatic checking for updates."
  win_command: reg query HKLM\Software\Policies\Microsoft\WindowsMediaPlayer /v DisableAutoupdate
  register: WMP_auto_update_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in WMP_auto_update_audit.stderr and WMP_auto_update_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-3480

- name: "MEDIUM | V-3480 | PATCH | Media Player must be configured to prevent automatic checking for updates."
  win_regedit:
      key: 'HKLM:\Software\Policies\Microsoft\WindowsMediaPlayer'
      value: DisableAutoupdate
      data: 1
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-3480

- name: "MEDIUM | V-3481 | AUDIT | Media Player will be configured to prevent automatic Codec downloads."
  win_command: reg query HKCU\Software\Policies\Microsoft\WindowsMediaPlayer /v PreventCodecDownload
  register: WMP_codec_download_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in WMP_codec_download_audit.stderr and WMP_codec_download_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-3481

- name: "MEDIUM | V-3481 | PATCH | Media Player will be configured to prevent automatic Codec downloads."
  win_regedit:
      key: 'HKCU:\Software\Policies\Microsoft\WindowsMediaPlayer'
      value: PreventCodecDownload
      data: 1
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-3481

- name: "MEDIUM | V-3487 | AUDIT | Services will be documented and unnecessary services will not be installed or will be disabled."
  win_shell: Get-Service | Where-Object {$_.Status -eq "Running"}
  register: running_services_audit
  check_mode: no
  changed_when: no
  tags:
      - cat2
      - medium
      - audit
      - V-3487

- name: "MEDIUM | V-3666 | AUDIT | The system will be configured to meet the minimum session security requirement for NTLM SSP based servers."
  win_command: reg query HKLM\System\CurrentControlSet\Control\Lsa\MSV1_0 /v NTLMMinServerSec
  register: NTLM_min_server_sec_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in NTLM_min_server_sec_audit.stderr and NTLM_min_server_sec_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-3666

- name: "MEDIUM | V-3666 | PATCH | The system will be configured to meet the minimum session security requirement for NTLM SSP based servers."
  win_regedit:
      key: 'HKLM:\System\CurrentControlSet\Control\Lsa\MSV1_0'
      value: NTLMMinServerSec
      data: 0x20080000
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-3666
