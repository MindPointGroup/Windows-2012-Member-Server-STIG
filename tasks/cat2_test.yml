- name: "MEDIUM | V-1097 | AUDIT | The system must lockout accounts after 3 invalid logon attempts within a specified time period."
  win_shell: net accounts | select-string -Pattern "threshold"
  register: lockout_threshold_audit
  check_mode: no
  changed_when: no
  tags:
      - cat2
      - medium
      - audit
      - V-1097

- name: "MEDIUM | V-1097 | PATCH | The system must lockout accounts after 3 invalid logon attempts within a specified time period."
  win_shell: net accounts /lockoutthreshold:5
  when: "'5' not in lockout_threshold_audit.stdout"
  tags:
      - cat2
      - medium
      - patch
      - V-1097

- name: "MEDIUM | V-1099 | AUDIT | The account lockout duration must be configured to require an administrator to unlock an account."
  debug: var=secedit_rules.System_Access.LockoutDuration
  check_mode: no
  changed_when: no
  tags:
      - cat2
      - medium
      - audit
      - V-1099

#- name: "MEDIUM | V-1099 | PATCH | The account lockout duration must be configured to require an administrator to unlock an account."
#  win_secedit: 
#      category: 'System Access'
#      key: LockoutDuration
#      value: -1
#  register: secedit
#  failed_when: "secedit.failed is defined and 'This host is joined to a Domain Controller' not in secedit.msg"
#  tags:
#      - cat2
#      - medium
#      - patch
#      - V-1099

- name: "MEDIUM | V-1104 | AUDIT | The maximum password age must be configured to 60 days or less."
  win_shell: net accounts | Select-String -Pattern "Max"
  register: max_password_age_audit
  check_mode: no
  changed_when: no
  tags:
      - cat2
      - medium
      - audit
      - V-1104

- name: "MEDIUM | V-1104 | PATCH | The maximum password age must be configured to 60 days or less."
  win_command: net accounts /maxpwage:60
  when: "'60' not in max_password_age_audit.stdout"
  tags:
      - cat2
      - medium
      - patch
      - V-1104

- name: "MEDIUM | V-1105 | AUDIT | The minimum password age must be configured to at least 1 day."
  debug: var=secedit_rules.System_Access.MinimumPasswordAge
  check_mode: no
  changed_when: no
  tags:
      - cat2
      - medium
      - audit
      - V-1105

#- name: "MEDIUM | V-1105 | PATCH | The minimum password age must be configured to at least 1 day."
#  win_command: net accounts /minpwage:0
#  when: secedit_rules.System_Access.MinimumPasswordAge != "0"
#  tags:
#      - cat2
#      - medium
#      - patch
#      - V-1105

- name: "MEDIUM | V-1107 | AUDIT | The password history must be configured to 24 passwords remembered."
  debug: var=secedit_rules.System_Access.PasswordHistorySize
  check_mode: no
  changed_when: no
  tags:
      - cat2
      - medium
      - audit
      - V-1107

#- name: "MEDIUM | V-1107 | PATCH | The password history must be configured to 24 passwords remembered."
#  win_secedit:
#      category: 'System Access'
#      key: PasswordHistorySize
#      value: '12'
#  register: secedit
#  failed_when: "secedit.failed is defined and 'This host is joined to a Domain Controller' not in secedit.msg"
#  tags:
#      - cat2
#      - medium
#      - patch
#      - V-1107

- name: "MEDIUM | V-1113 | AUDIT | The built-in guest account must be disabled."
  debug: var=secedit_rules.System_Access.EnableGuestAccount
  check_mode: no
  changed_when: no
  tags:
      - cat2
      - medium
      - audit
      - V-1113

#- name: "MEDIUM | V-1113 | PATCH | The built-in guest account must be disabled."
#  win_secedit:
#      category: 'System Access'
#      key: EnableGuestAccount
#      value: '0'
#  register: secedit
#  failed_when: "secedit.failed is defined and 'This host is joined to a Domain Controller' not in secedit.msg"
#  tags:
#      - cat2
#      - medium
#      - patch
#      - V-1113

- name: "MEDIUM | V-1119 | AUDIT | Booting into alternate non STIG compliant operating systems will not be permitted."
  win_command: bcdedit
  register: OS_list_audit
  check_mode: no
  changed_when: no
  tags:
      - cat2
      - medium
      - audit
      - V-1119

- name: "MEDIUM | V-1141 | AUDIT | Unencrypted passwords must not be sent to third-party SMB Servers."
  win_command: reg query HKLM\SYSTEM\CurrentControlSet\Services\LanmanWorkstation\Parameters /v EnablePlainTextPassword
  register: plain_text_password_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in plain_text_password_audit.stderr and plain_text_password_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-1141

- name: "MEDIUM | V-1141 | PATCH | Unencrypted passwords must not be sent to third-party SMB Servers."
  win_regedit:
      key: 'HKLM:\SYSTEM\CurrentControlSet\Services\LanmanWorkstation\Parameters'
      value: EnablePlainTextPassword
      data: 0
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-1141

- name: "MEDIUM | V-1145 | AUDIT | Automatic logons must be disabled."
  win_command: reg query \"HKLM\Software\Microsoft\Windows NT\CurrentVersion\Winlogon\" /v AutoAdminLogon
  register: disable_automatic_logons_audit
  check_mode: no
  changed_when: no
  ignore_errors: yes
  failed_when: "reg_not_found not in disable_automatic_logons_audit.stderr and disable_automatic_logons_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-1145

- name: "MEDIUM | V-1145 | PATCH | Automatic logons must be disabled."
  win_regedit:
    key: 'HKLM:\Software\Microsoft\Windows NT\CurrentVersion\Winlogon'
    value: AutoAdminLogon
    data: 0
  tags:
      - cat2
      - medium
      - patch
      - V-1145

- name: "MEDIUM | V-1150 | AUDIT | The built-in Windows password complexity policy must be enabled."
  debug: var=secedit_rules.System_Access.PasswordComplexity
  check_mode: no
  changed_when: no
  tags:
      - cat2
      - medium
      - audit
      - V-1150

#- name: "MEDIUM | V-1150 | PATCH | The built-in Windows password complexity policy must be enabled."
#  win_secedit:
#      category: 'System Access'
#      key: PasswordComplexity
#      value: '1'
#  register: secedit
#  failed_when: "secedit.failed is defined and 'This host is joined to a Domain Controller' not in secedit.msg"
#  tags:
#      - cat2
#      - medium
#      - patch
#      - V-1150

- name: "MEDIUM | V-1154 | AUDIT | The Ctrl+Alt+Del security attention sequence for logons will be enabled."
  win_command: reg query HKLM\Software\Microsoft\Windows\CurrentVersion\Policies\System /v DisableCAD
  register: disable_CAD_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in disable_CAD_audit.stderr and disable_CAD_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-1154

- name: "MEDIUM | V-1154 | PATCH | The Ctrl+Alt+Del security attention sequence for logons will be enabled."
  win_regedit: 
      key: 'HKLM:\Software\Microsoft\Windows\CurrentVersion\Policies\System'
      value: DisableCAD
      data: 0
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-1154

- name: "MEDIUM | V-1162 | AUDIT | The Windows SMB server will perform SMB packet signing when possible."
  win_command: reg query HKLM\System\CurrentControlSet\Services\LanManServer\Parameters /v EnableSecuritySignature
  register: SMB_server_packet_signing_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in SMB_server_packet_signing_audit.stderr and SMB_server_packet_signing_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-1162

- name: "MEDIUM | V-1163 | AUDIT | Outgoing secure channel traffic will be encrypted when possible."
  win_command: reg query HKLM\System\CurrentControlSet\Services\Netlogon\Parameters /v SealSecureChannel
  register: encrypt_outgoing_secure_channel_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in encrypt_outgoing_secure_channel_audit.stderr and encrypt_outgoing_secure_channel_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-1163

- name: "MEDIUM | V-1163 | PATCH | Outgoing secure channel traffic will be encrypted when possible."
  win_regedit:
      key: 'HKLM:\System\CurrentControlSet\Services\Netlogon\Parameters'
      value: SealSecureChannel
      data: 1
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-1163

- name: "MEDIUM | V-1164 | AUDIT | Outgoing secure channel traffic will be signed when possible."
  win_command: reg query HKLM\System\CurrentControlSet\Services\Netlogon\Parameters /v SignSecureChannel
  register: sign_outgoing_secure_channel_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in sign_outgoing_secure_channel_audit.stderr and sign_outgoing_secure_channel_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-1164

- name: "MEDIUM | V-1164 | PATCH | Outgoing secure channel traffic will be signed when possible."
  win_regedit:
      key: 'HKLM:\System\CurrentControlSet\Services\Netlogon\Parameters'
      value: SignSecureChannel
      data: 1
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-1164

- name: "MEDIUM | V-1166 | AUDIT | The Windows SMB client will be enabled to perform SMB packet signing when possible."
  win_command: reg query HKLM\System\CurrentControlSet\Services\LanmanWorkstation\Parameters /v EnableSecuritySignature
  register: SMB_client_packet_signing_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in SMB_client_packet_signing_audit.stderr and SMB_client_packet_signing_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-1166

- name: "MEDIUM | V-1171 | AUDIT | Ejection of removable NTFS media is not restricted to Administrators."
  win_command: reg query \"HKLM\Software\Microsoft\Windows NT\CurrentVersion\Winlogon\" /v AllocateDASD
  register: eject_removable_media_audit
  check_mode: no
  changed_when: no
  ignore_errors: yes
  failed_when: "reg_not_found not in eject_removable_media_audit.stderr and eject_removable_media_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-1171

- name: "MEDIUM | V-1171 | PATCH | Ejection of removable NTFS media is not restricted to Administrators."
  win_regedit:
      key: 'HKLM:\Software\Microsoft\Windows NT\CurrentVersion\Winlogon'
      value: AllocateDASD
      data: 0
  ignore_errors: yes
  tags:
      - cat2
      - medium
      - patch
      - V-1171

- name: "MEDIUM | V-3245 | AUDIT | File share ACLs will be reconfigured to remove the Everyone group."
  win_shell:  Get-WmiObject -Class Win32_Share | Get-Acl | fl
  register: eject_removable_media_audit
  check_mode: no
  changed_when: no
  failed_when: "path_is_null not in eject_removable_media_audit.stderr and eject_removable_media_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-3245

- name: "MEDIUM | V-3374 | AUDIT | The system must be configured to require a strong session key."
  win_command: reg query HKLM\System\CurrentControlSet\Services\Netlogon\Parameters\ /v RequireStrongKey
  register: strong_sessionkey_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in strong_sessionkey_audit.stderr and strong_sessionkey_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-3374

- name: "MEDIUM | V-3374 | PATCH | The system must be configured to require a strong session key."
  win_regedit:
      key: 'HKLM:\System\CurrentControlSet\Services\Netlogon\Parameters\'
      value: RequireStrongKey
      data: 1
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-3374

- name: "MEDIUM | V-3376 | AUDIT | The system will be configured to prevent the storage of passwords and credentials"
  win_command: reg query HKLM\System\CurrentControlSet\Control\Lsa /v DisableDomainCreds
  register: creds_storage_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in creds_storage_audit.stderr and creds_storage_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-3376

- name: "MEDIUM | V-3376 | PATCH | The system will be configured to prevent the storage of passwords and credentials"
  win_regedit:
      key: 'HKLM:\System\CurrentControlSet\Control\Lsa'
      value: DisableDomainCreds
      data: 1
      datatype: dword
      tags:
          - cat2
          - medium
          - patch
          - V-3376

- name: "MEDIUM | V-3377 | AUDIT | The system will be configured to prevent anonymous users from having the same rights as the Everyone group."
  win_command: reg query HKLM\System\CurrentControlSet\Control\Lsa /v EveryoneIncludesAnonymous
  register: everyone_includes_anon_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in everyone_includes_anon_audit.stderr and everyone_includes_anon_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-3377

- name: "MEDIUM | V-3377 | PATCH | The system will be configured to prevent anonymous users from having the same rights as the Everyone group."
  win_regedit:
      key: 'HKLM:\System\CurrentControlSet\Control\Lsa'
      value: EveryoneIncludesAnonymous
      data: 0
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-3377

- name: "MEDIUM | V-3378 | AUDIT | The system will be configured to use the Classic security model."
  win_command: reg query HKLM\System\CurrentControlSet\Control\Lsa /v ForceGuest
  register: classic_security_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in classic_security_audit.stderr and classic_security_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-3378

- name: "MEDIUM | V-3378 | PATCH | The system will be configured to use the Classic security model."
  win_regedit:
      key: 'HKLM:\System\CurrentControlSet\Control\Lsa'
      value: ForceGuest
      data: 0
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-3378

- name: "MEDIUM | V-3381 | AUDIT | The system will be configured to the required LDAP client signing level."
  win_command: reg query HKLM\System\CurrentControlSet\Services\LDAP /v LDAPClientIntegrity
  register: LDAP_client_integrity_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in LDAP_client_integrity_audit.stderr and LDAP_client_integrity_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-3381

- name: "MEDIUM | V-3381 | PATCH | The system will be configured to the required LDAP client signing level."
  win_regedit:
      key: 'HKLM:\System\CurrentControlSet\Services\LDAP'
      value: LDAPClientIntegrity
      data: 1
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-3381

- name: "MEDIUM | V-3382 | AUDIT | The system will be configured to meet the minimum session security requirement for NTLM SSP based clients."
  win_command: reg query HKLM\System\CurrentControlSet\Control\Lsa\MSV1_0 /v NTLMMinClientSec
  register: NTLM_min_client_sec_audit
  check_mode: no
  changed_when: "'0x20080000' not in NTLM_min_client_sec_audit.stdout"
  failed_when: "reg_not_found not in NTLM_min_client_sec_audit.stderr and NTLM_min_client_sec_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-3382

- name: "MEDIUM | V-3382 | PATCH | The system will be configured to meet the minimum session security requirement for NTLM SSP based clients."
  win_regedit:
      key: 'HKLM:\System\CurrentControlSet\Control\Lsa\MSV1_0'
      value: NTLMMinClientSec
      data: 0x20080000
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-3382

- name: "MEDIUM | V-3385 | AUDIT | The system must be configured to require case insensitivity for non-Windows subsystems."
  win_command: reg query \"HKLM\System\CurrentControlSet\Control\Session Manager\Kernel\" /v ObCaseInsensitive
  register: case_insensitive_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in case_insensitive_audit.stderr and case_insensitive_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-3385

- name: "MEDIUM | V-3385 | PATCH | The system must be configured to require case insensitivity for non-Windows subsystems."
  win_regedit:
      key: 'HKLM:\System\CurrentControlSet\Control\Session Manager\Kernel'
      value: ObCaseInsensitive
      data: 1
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-3385

- name: "MEDIUM | V-3449 | AUDIT | Remote Desktop Services will limit users to one remote session."
  win_command: reg query \"HKLM\Software\Policies\Microsoft\Windows NT\Terminal Services\" /v fSingleSessionPerUser
  register: single_rdp_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in single_rdp_audit.stderr and single_rdp_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-3449

- name: "MEDIUM | V-3449 | PATCH | Remote Desktop Services will limit users to one remote session."
  win_regedit:
      key: 'HKLM:\Software\Policies\Microsoft\Windows NT\Terminal Services'
      value: fSingleSessionPerUser
      data: 1
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-3449

- name: "MEDIUM | V-3453 | AUDIT | Remote Desktop Services will always prompt a client for passwords upon connection."
  win_command: reg query \"HKLM\Software\Policies\Microsoft\Windows NT\Terminal Services\" /v fPromptForPassword
  register: rdp_password_prompt_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in rdp_password_prompt_audit.stderr and rdp_password_prompt_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-3453

- name: "MEDIUM | V-3453 | PATCH | Remote Desktop Services will always prompt a client for passwords upon connection."
  win_regedit:
      key: 'HKLM:\Software\Policies\Microsoft\Windows NT\Terminal Services'
      value: fPromptForPassword
      data: 1
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-3453

- name: "MEDIUM | V-3454 | AUDIT | Remote Desktop Services will be configured with the client connection encryption set to the required level."
  win_command: reg query \"HKLM\Software\Policies\Microsoft\Windows NT\Terminal Services\" /v MinEncryptionLevel
  register: min_encrypt_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in min_encrypt_audit.stderr and min_encrypt_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-3454

- name: "MEDIUM | V-3455 | AUDIT | Remote Desktop Services will be configured to use session-specific temporary folders."
  win_command: reg query \"HKLM\Software\Policies\Microsoft\Windows NT\Terminal Services\" /v PerSessionTempDir
  register: temp_folder_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in temp_folder_audit.stderr and temp_folder_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-3455

- name: "MEDIUM | V-3455 | PATCH | Remote Desktop Services will be configured to use session-specific temporary folders."
  win_regedit:
      key: 'HKLM:\Software\Policies\Microsoft\Windows NT\Terminal Services'
      value: PerSessionTempDir
      data: 1
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-3455

- name: "MEDIUM | V-3456 | AUDIT | Remote Desktop Services will delete temporary folders when a session is terminated."
  win_command: reg query \"HKLM\Software\Policies\Microsoft\Windows NT\Terminal Services\" /v DeleteTempDirsOnExit
  register: delete_temp_folder_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in delete_temp_folder_audit.stderr and delete_temp_folder_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-3456

- name: "MEDIUM | V-3456 | PATCH | Remote Desktop Services will delete temporary folders when a session is terminated."
  win_regedit:
      key: 'HKLM:\Software\Policies\Microsoft\Windows NT\Terminal Services'
      value: DeleteTempDirsOnExit
      data: 1
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-3456

- name: "MEDIUM | V-3457 | AUDIT | Remote Desktop Services will be configured to set a time limit for disconnected sessions."
  win_command: reg query \"HKLM\Software\Policies\Microsoft\Windows NT\Terminal Services\" /v MaxDisconnectionTime
  register: max_disconnection_time_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in max_disconnection_time_audit.stderr and max_disconnection_time_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-3457

- name: "MEDIUM | V-3457 | PATCH | Remote Desktop Services will be configured to set a time limit for disconnected sessions."
  win_regedit:
      key: 'HKLM:\Software\Policies\Microsoft\Windows NT\Terminal Services'
      value: MaxDisconnectionTime
      data: 0x0000ea60
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-3457

- name: "MEDIUM | V-3458 | AUDIT | Remote Desktop Services will be configured to disconnect an idle session after the specified time period."
  win_command: reg query \"HKLM\Software\Policies\Microsoft\Windows NT\Terminal Services\" /v MaxIdleTime
  register: max_idle_time_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in max_idle_time_audit.stderr and max_idle_time_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-3458

- name: "MEDIUM | V-3458 | PATCH | Remote Desktop Services will be configured to disconnect an idle session after the specified time period."
  win_regedit:
      key: 'HKLM:\Software\Policies\Microsoft\Windows NT\Terminal Services'
      value: MaxIdleTime
      data: 0x000dbba0
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-3458

- name: "MEDIUM | V-3469 | AUDIT | The system will be configured to enable the background refresh of Group Policy."
  win_command: reg query HKLM\Software\Microsoft\Windows\CurrentVersion\Policies\system /v DisableBkGndGroupPolicy
  register: background_group_policy_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in background_group_policy_audit.stderr and background_group_policy_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-3469

- name: "MEDIUM | V-3469 | PATCH | The system will be configured to enable the background refresh of Group Policy."
  win_regedit:
      key: 'HKLM:\Software\Microsoft\Windows\CurrentVersion\Policies\system'
      value: DisableBkGndGroupPolicy
      data: 0
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-3469

- name: "MEDIUM | V-3470 | AUDIT | The system will be configured to prevent unsolicited remote assistance offers."
  win_command: reg query \"HKLM\Software\Policies\Microsoft\Windows NT\Terminal Services\" /v fAllowUnsolicited
  register: unsolicited_remote_assistance_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in unsolicited_remote_assistance_audit.stderr and unsolicited_remote_assistance_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-3470

- name: "MEDIUM | V-3470 | PATCH | The system will be configured to prevent unsolicited remote assistance offers."
  win_regedit:
      key: 'HKLM:\Software\Policies\Microsoft\Windows NT\Terminal Services'
      value: fAllowUnsolicited
      data: 0
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-3470

- name: "MEDIUM | V-3479 | AUDIT | The system will be configured to use Safe DLL Search Mode."
  win_command: reg query \"HKLM\System\CurrentControlSet\Control\Session Manager\" /v SafeDllSearchMode
  register: safe_DLL_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in safe_DLL_audit.stderr and safe_DLL_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-3479

- name: "MEDIUM | V-3479 | PATCH | The system will be configured to use Safe DLL Search Mode."
  win_regedit:
      key: 'HKLM:\System\CurrentControlSet\Control\Session Manager'
      value: SafeDllSearchMode
      data: 1
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-3479

- name: "MEDIUM | V-3480 | AUDIT | Media Player must be configured to prevent automatic checking for updates."
  win_command: reg query HKLM\Software\Policies\Microsoft\WindowsMediaPlayer /v DisableAutoupdate
  register: WMP_auto_update_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in WMP_auto_update_audit.stderr and WMP_auto_update_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-3480

- name: "MEDIUM | V-3480 | PATCH | Media Player must be configured to prevent automatic checking for updates."
  win_regedit:
      key: 'HKLM:\Software\Policies\Microsoft\WindowsMediaPlayer'
      value: DisableAutoupdate
      data: 1
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-3480

- name: "MEDIUM | V-3481 | AUDIT | Media Player will be configured to prevent automatic Codec downloads."
  win_command: reg query HKCU\Software\Policies\Microsoft\WindowsMediaPlayer /v PreventCodecDownload
  register: WMP_codec_download_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in WMP_codec_download_audit.stderr and WMP_codec_download_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-3481

- name: "MEDIUM | V-3481 | PATCH | Media Player will be configured to prevent automatic Codec downloads."
  win_regedit:
      key: 'HKCU:\Software\Policies\Microsoft\WindowsMediaPlayer'
      value: PreventCodecDownload
      data: 1
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-3481

- name: "MEDIUM | V-3487 | AUDIT | Services will be documented and unnecessary services will not be installed or will be disabled."
  win_shell: Get-Service | Where-Object {$_.Status -eq "Running"}
  register: running_services_audit
  check_mode: no
  changed_when: no
  tags:
      - cat2
      - medium
      - audit
      - V-3487

- name: "MEDIUM | V-3666 | AUDIT | The system will be configured to meet the minimum session security requirement for NTLM SSP based servers."
  win_command: reg query HKLM\System\CurrentControlSet\Control\Lsa\MSV1_0 /v NTLMMinServerSec
  register: NTLM_min_server_sec_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in NTLM_min_server_sec_audit.stderr and NTLM_min_server_sec_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-3666

- name: "MEDIUM | V-3666 | PATCH | The system will be configured to meet the minimum session security requirement for NTLM SSP based servers."
  win_regedit:
      key: 'HKLM:\System\CurrentControlSet\Control\Lsa\MSV1_0'
      value: NTLMMinServerSec
      data: 0x20080000
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-3666

- name: "MEDIUM | V-4446 | AUDIT | Software certificate restriction policies will be enforced."
  win_command: reg query HKLM\Software\Policies\Microsoft\Windows\Safer\CodeIdentifiers /v AuthenticodeEnabled
  register: software_restricition_policies_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in software_restricition_policies_audit.stderr and software_restricition_policies_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-4446

- name: "MEDIUM | V-4446 | PATCH | Software certificate restriction policies will be enforced."
  win_regedit:
      key: 'HKLM:\Software\Policies\Microsoft\Windows\Safer\CodeIdentifiers'
      value: AuthenticodeEnabled
      data: 1
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-4446

- name: "MEDIUM | V-4447 | AUDIT | The Remote Desktop Session Host will require secure RPC communications."
  win_command: reg query \"HKLM\Software\Policies\Microsoft\Windows NT\Terminal Services\" /v fEncryptRPCTraffic
  register: encrypt_RPC_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in encrypt_RPC_audit.stderr and encrypt_RPC_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-4447

- name: "MEDIUM | V-4447 | PATCH | The Remote Desktop Session Host will require secure RPC communications."
  win_regedit:
      key: 'HKLM:\Software\Policies\Microsoft\Windows NT\Terminal Services'
      value: fEncryptRPCTraffic
      data: 1
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-4447

- name: "MEDIUM | V-4448 | AUDIT | Group Policy objects will be reprocessed even if they have not changed."
  win_command: reg query \"HKLM\Software\Policies\Microsoft\Windows\Group Policy\{35378EAC-683F-11D2-A89A-00C04FBBCFA2}\" /v NoGPOListChanges
  register: reprocess_GPO_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in reprocess_GPO_audit.stderr and reprocess_GPO_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-4448

- name: "MEDIUM | V-4448 | PATCH | Group Policy objects will be reprocessed even if they have not changed."
  win_regedit:
      key: 'HKLM:\Software\Policies\Microsoft\Windows\Group Policy\{35378EAC-683F-11D2-A89A-00C04FBBCFA2}'
      value: NoGPOListChanges
      data: 0
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-4448

- name: "MEDIUM | V-6831 | AUDIT | Outgoing secure channel traffic will be encrypted or signed."
  win_command: reg query HKLM\System\CurrentControlSet\Services\Netlogon\Parameters /v RequireSignOrSeal
  register: encrypt_or_sign_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in encrypt_or_sign_audit.stderr and encrypt_or_sign_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-6831

- name: "MEDIUM | V-6831 | PATCH | Outgoing secure channel traffic will be encrypted or signed."
  win_regedit:
      key: 'HKLM:\System\CurrentControlSet\Services\Netlogon\Parameters'
      value: RequireSignOrSeal
      data: 1
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-6831

- name: "MEDIUM | V-6832 | AUDIT | The Windows SMB client will be enabled to always perform SMB packet signing."
  win_command: reg query HKLM\System\CurrentControlSet\Services\LanmanWorkstation\Parameters /v RequireSecuritySignature
  register: require_SMB_client_packet_signing_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in require_SMB_client_packet_signing_audit.stderr and require_SMB_client_packet_signing_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-6832

- name: "MEDIUM | V-6833 | AUDIT | The Windows SMB server will be enabled to always perform SMB packet signing."
  win_command: reg query HKLM\System\CurrentControlSet\Services\LanManServer\Parameters /v RequireSecuritySignature
  register: require_SMB_server_packet_signing_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in require_SMB_server_packet_signing_audit.stderr and require_SMB_server_packet_signing_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-6833

- name: "MEDIUM | V-14228 | AUDIT | Auditing Access of Global System Objects must be turned off."
  win_command: reg query HKLM\System\CurrentControlSet\Control\Lsa /v AuditBaseObjects
  register: audit_base_objects_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in audit_base_objects_audit.stderr and audit_base_objects_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-14228

- name: "MEDIUM | V-14228 | PATCH | Auditing Access of Global System Objects must be turned off."
  win_regedit:
      key: 'HKLM:\System\CurrentControlSet\Control\Lsa'
      value: AuditBaseObjects
      data: 0
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-14228

- name: "MEDIUM | V-14229 | AUDIT | Audit of Backup and Restore Privileges will be turned off."
  win_command: reg query HKLM\System\CurrentControlSet\Control\Lsa /v FullPrivilegeAuditing
  register: full_privilege_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in full_privilege_audit.stderr and full_privilege_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-14229

# win_regedit requires 2 octects for binary values to detect if a change is needed or not.
- name: "MEDIUM | V-14229 | PATCH | Audit of Backup and Restore Privileges will be turned off."
  win_regedit:
      key: 'HKLM:\System\CurrentControlSet\Control\Lsa'
      value: FullPrivilegeAuditing
      data: 0x0,0x0
      datatype: binary
  tags:
      - cat2
      - medium
      - patch
      - V-14229

- name: "MEDIUM | V-14230 | AUDIT | Audit policy using subcategories will be enabled."
  win_command: reg query HKLM\System\CurrentControlSet\Control\Lsa /v SCENoApplyLegacyAuditPolicy
  register: subcategories_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in subcategories_audit.stderr and subcategories_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-14230

- name: "MEDIUM | V-14230 | PATCH | Audit policy using subcategories will be enabled."
  win_regedit:
      key: 'HKLM:\System\CurrentControlSet\Control\Lsa'
      value: SCENoApplyLegacyAuditPolicy
      data: 1
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-14230

- name: "MEDIUM | V-14234 | AUDIT | User Account Control approval mode for the built-in Administrator will be enabled."
  win_command: reg query HKLM\Software\Microsoft\Windows\CurrentVersion\Policies\System /v FilterAdministratorToken
  register: admin_approval_mode_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in admin_approval_mode_audit.stderr and admin_approval_mode_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-14234

- name: "MEDIUM | V-14235 | AUDIT | User Account Control will, at a minimum, prompt administrators for consent."
  win_command: reg query HKLM\Software\Microsoft\Windows\CurrentVersion\Policies\System /v ConsentPromptBehaviorAdmin
  register: admin_consent_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in admin_consent_audit.stderr and admin_consent_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-14235

- name: "MEDIUM | V-14236 | AUDIT | User Account Control will automatically deny standard user requests for elevation."
  win_command: reg query HKLM\Software\Microsoft\Windows\CurrentVersion\Policies\System /v ConsentPromptBehaviorUser
  register: user_consent_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in user_consent_audit.stderr and user_consent_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-14236

- name: "MEDIUM | V-14239 | AUDIT | User Account Control will only elevate UIAccess applications that are installed in secure locations"
  win_command: reg query HKLM\Software\Microsoft\Windows\CurrentVersion\Policies\System /v EnableSecureUIAPaths
  register: enable_secure_UIA_paths_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in enable_secure_UIA_paths_audit.stderr and enable_secure_UIA_paths_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-14239

- name: "MEDIUM | V-14240 | AUDIT | User Account Control will run all administrators in Admin Approval Mode, enabling UAC."
  win_command: reg query HKLM\Software\Microsoft\Windows\CurrentVersion\Policies\System /v EnableLUA
  register: enable_UAC
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in enable_UAC.stderr and enable_UAC.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-14240

- name: "MEDIUM | V-14241 | AUDIT | User Account Control will switch to the secure desktop when prompting for elevation."
  win_command: reg query HKLM\Software\Microsoft\Windows\CurrentVersion\Policies\System /v PromptOnSecureDesktop
  register: prompt_on_secure_desktop_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in prompt_on_secure_desktop_audit.stderr and prompt_on_secure_desktop_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-14241

- name: "MEDIUM | V-14242 | AUDIT | User Account Control will virtualize file and registry write failures to per-user locations."
  win_command: reg query HKLM\Software\Microsoft\Windows\CurrentVersion\Policies\System /v EnableVirtualization
  register: UAC_virtualization_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in UAC_virtualization_audit.stderr and UAC_virtualization_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-14242

- name: "MEDIUM | V-14247 | AUDIT | Passwords will not be saved in the Remote Desktop Client."
  win_command: reg query \"HKLM\Software\Policies\Microsoft\Windows NT\Terminal Services\" /v DisablePasswordSaving
  register: disable_RDC_password_saving_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in disable_RDC_password_saving_audit.stderr and disable_RDC_password_saving_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-14247

- name: "MEDIUM | V-14247 | PATCH | Passwords will not be saved in the Remote Desktop Client."
  win_regedit:
      key: 'HKLM:\Software\Policies\Microsoft\Windows NT\Terminal Services'
      value: DisablePasswordSaving
      data: 1
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-14247

- name: "MEDIUM | V-14249 | AUDIT | Local drives will be prevented from sharing with Remote Desktop Session Hosts (Remote Desktop Services Role)."
  win_command: reg query \"HKLM\Software\Policies\Microsoft\Windows NT\Terminal Services\" /v fDisableCdm
  register: disable_local_drive_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in disable_local_drive_audit.stderr and disable_local_drive_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-14249

- name: "MEDIUM | V-14249 | PATCH | Local drives will be prevented from sharing with Remote Desktop Session Hosts (Remote Desktop Services Role)."
  win_regedit:
      key: 'HKLM:\Software\Policies\Microsoft\Windows NT\Terminal Services'
      value: fDisableCdm
      data: 1
      datatype: dword
  tags:
    - cat2
    - medium
    - patch
    - V-14249

- name: "MEDIUM | V-14253 | AUDIT | Unauthenticated RPC clients must be restricted from connecting to the RPC server."
  win_command: reg query \"HKLM\SOFTWARE\Policies\Microsoft\Windows NT\Rpc\" /v RestrictRemoteClients
  register: restrict_remote_clients_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in restrict_remote_clients_audit.stderr and restrict_remote_clients_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-14253

- name: "MEDIUM | V-14253 | PATCH | Unauthenticated RPC clients must be restricted from connecting to the RPC server."
  win_regedit: 
      key: 'HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Rpc'
      value: RestrictRemoteClients
      data: 1
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-14253

- name: "MEDIUM | V-14254 | AUDIT | Client computers must be required to authenticate for RPC communication."
  win_command: reg query \"HKLM\SOFTWARE\Policies\Microsoft\Windows NT\Rpc\" /v EnableAuthEpResolution
  register: require_auth_RPC_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in require_auth_RPC_audit.stderr and require_auth_RPC_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-14254

- name: "MEDIUM | V-14254 | PATCH | Client computers must be required to authenticate for RPC communication."
  win_regedit: 
      key: 'HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Rpc'
      value: EnableAuthEpResolution
      data: 1
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-14254

me: "MEDIUM | V-14259 | AUDIT | Printing over HTTP will be prevented."
  win_command: reg query \"HKLM\Software\Policies\Microsoft\Windows NT\Printers\" /v DisableHTTPPrinting
  register: disable_HTTP_printing_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in disable_HTTP_printing_audit.stderr and disable_HTTP_printing_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-14259

- name: "MEDIUM | V-14259 | PATCH | Printing over HTTP will be prevented."
  win_regedit:
      key: 'HKLM:\Software\Policies\Microsoft\Windows NT\Printers'
      value: DisableHTTPPrinting
      data: 1
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-14259

- name: "MEDIUM | V-14260 | AUDIT | Downloading print driver packages over HTTP will be prevented."
  win_command: reg query \"HKLM\Software\Policies\Microsoft\Windows NT\Printers\" /v DisableWebPnPDownload
  register: disable_HTTP_printer_drivers_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in disable_HTTP_printer_drivers_audit.stderr and disable_HTTP_printer_drivers_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-14260

- name: "MEDIUM | V-14260 | PATCH | Downloading print driver packages over HTTP will be prevented."
  win_regedit:
      key: 'HKLM:\Software\Policies\Microsoft\Windows NT\Printers'
      value: DisableWebPnPDownload
      data: 1
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-14260

- name: "MEDIUM | V-14261 | AUDIT | Windows will be prevented from using Windows Update to search for drivers."
  win_command: reg query HKLM\Software\Policies\Microsoft\Windows\DriverSearching /v DontSearchWindowsUpdate
  register: windows_update_driver_search_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in windows_update_driver_search_audit.stderr and windows_update_driver_search_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-14261

- name: "MEDIUM | V-14261 | PATCH | Windows will be prevented from using Windows Update to search for drivers."
  win_regedit:
      key: 'HKLM:\Software\Policies\Microsoft\Windows\DriverSearching'
      value: DontSearchWindowsUpdate
      data: 1
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-14261

- name: "MEDIUM | V-14268 | AUDIT | Zone information will be preserved when saving attachments."
  win_command: reg query HKCU\Software\Microsoft\Windows\CurrentVersion\Policies\Attachments /v SaveZoneInformation
  register: save_zone_info_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in save_zone_info_audit.stderr and save_zone_info_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-14268

- name: "MEDIUM | V-14268 | PATCH | Zone information will be preserved when saving attachments."
  win_regedit:
      key: 'HKCU:\Software\Microsoft\Windows\CurrentVersion\Policies\Attachments'
      value: SaveZoneInformation
      data: 2
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-14268

- name: "MEDIUM | V-14269 | AUDIT | Mechanisms for removing zone information from file attachments will be hidden."
  win_command: reg query HKCU\Software\Microsoft\Windows\CurrentVersion\Policies\Attachments /v HideZoneInfoOnProperties
  register: hide_zone_info_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in hide_zone_info_audit.stderr and hide_zone_info_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-14269

- name: "MEDIUM | V-14269 | PATCH | Mechanisms for removing zone information from file attachments will be hidden."
  win_regedit:
      key: 'HKCU:\Software\Microsoft\Windows\CurrentVersion\Policies\Attachments'
      value: HideZoneInfoOnProperties
      data: 1
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-14269

- name: "MEDIUM | V-15666 | AUDIT | Windows Peer-to-Peer networking services will be turned off."
  win_command: reg query HKLM\Software\Policies\Microsoft\Peernet /v Disabled
  register: p2p_net_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in p2p_net_audit.stderr and p2p_net_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-15666

- name: "MEDIUM | V-15666 | PATCH | Windows Peer-to-Peer networking services will be turned off."
  win_regedit:
      key: 'HKLM:\Software\Policies\Microsoft\Peernet'
      value: Disabled
      data: 1
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-15666

- name: "MEDIUM | V-15667 | AUDIT | Network Bridges will be prohibited in Windows."
  win_command: reg query \"HKLM\Software\Policies\Microsoft\Windows\Network Connections\" /v NC_AllowNetBridge_NLA
  register: network_bridge_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in network_bridge_audit.stderr and network_bridge_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-15667

- name: "MEDIUM | V-15667 | PATCH | Network Bridges will be prohibited in Windows."
  win_regedit:
      key: 'HKLM:\Software\Policies\Microsoft\Windows\Network Connections'
      value: NC_AllowNetBridge_NLA
      data: 0
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-15667

- name: "MEDIUM | V-15682 | AUDIT | Attachments must be prevented from being downloaded from RSS feeds."
  win_command: reg query \"HKLM\SOFTWARE\Policies\Microsoft\Internet Explorer\Feeds\" /v DisableEnclosureDownload
  register: no_attachments_from_RSS_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in no_attachments_from_RSS_audit.stderr and no_attachments_from_RSS_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-15682

- name: "MEDIUM | V-15682 | PATCH | Attachments must be prevented from being downloaded from RSS feeds."
  win_regedit:
      key: 'HKLM:\SOFTWARE\Policies\Microsoft\Internet Explorer\Feeds'
      value: DisableEnclosureDownload
      data: 1
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-15682

- name: "MEDIUM | V-15683 | AUDIT | Windows Explorer shell protocol will run in protected mode."
  win_command: reg query HKLM\Software\Microsoft\Windows\CurrentVersion\Policies\Explorer /v PreXPSP2ShellProtocolBehavior
  register: shell_protocol_protected_mode_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in shell_protocol_protected_mode_audit.stderr and shell_protocol_protected_mode_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-15683

- name: "MEDIUM | V-15684 | AUDIT | Users will be notified if a web-based program attempts to install software."
  win_command: reg query HKLM\Software\Policies\Microsoft\Windows\Installer /v SafeForScripting
  register: install_notification_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in install_notification_audit.stderr and install_notification_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-15684

- name: "MEDIUM | V-15684 | PATCH | Users will be notified if a web-based program attempts to install software."
  win_regedit:
      key: 'HKLM:\Software\Policies\Microsoft\Windows\Installer'
      value: SafeForScripting
      data: 0
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-15684

- name: "MEDIUM | V-15696 | AUDIT | The Mapper I/O network protocol driver will be disabled."
  win_command: reg query HKLM\Software\Policies\Microsoft\Windows\LLTD /v {{ item }}
  register: disable_mapper_IO_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in disable_mapper_IO_audit.stderr and disable_mapper_IO_audit.stderr"
  with_items:
      - AllowLLTDIOOndomain
      - AllowLLTDIOOnPublicNet
      - EnableLLTDIO
      - ProhibitLLTDIOOnPrivateNet
  tags:
      - cat2
      - medium
      - audit
      - V-15696

#- name: "MEDIUM | V-15696 | PATCH | The Mapper I/O network protocol driver will be disabled."
#  win_regedit: 
#      key: 'HKLM:\Software\Policies\Microsoft\Windows\LLTD'
#      value: "{{ item }}"
#      data: 0
#      datatype: dword
#  with_items: 
#      - AllowLLTDIOOndomain
#      - AllowLLTDIOOnPublicNet
#      - EnableLLTDIO
#      - ProhibitLLTDIOOnPrivateNet
#  tags:
#      - cat2
#      - medium
#      - patch
#      - V-15696

- name: "MEDIUM | V-15697 | AUDIT | The Responder network protocol driver will be disabled."
  win_command: reg query HKLM\Software\Policies\Microsoft\Windows\LLTD /v {{ item }}
  register: diable_responder_protocol_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in diable_responder_protocol_audit.stderr and diable_responder_protocol_audit.stderr"
  with_items:
      - AllowRspndrOndomain
      - AllowRspndrOnPublicNet
      - EnableRspndr
      - ProhibitRspndrOnPrivateNet
  tags:
      - cat2
      - medium
      - audit
      - V-15697

- name: "MEDIUM | V-15697 | PATCH | The Responder network protocol driver will be disabled."
  win_regedit:
      key: 'HKLM:\Software\Policies\Microsoft\Windows\LLTD'
      value: "{{ item }}"
      data: 0
      datatype: dword
  with_items:
      - AllowRspndrOndomain
      - AllowRspndrOnPublicNet
      - EnableRspndr
      - ProhibitRspndrOnPrivateNet
  tags:
      - cat2
      - medium
      - patch
      - V-15697

- name: "MEDIUM | V-15698 | AUDIT | The configuration of wireless devices using Windows Connect Now will be disabled."
  win_command: reg query HKLM\Software\Policies\Microsoft\Windows\WCN\Registrars /v {{ item }}
  register: WCN_config_drivers_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in WCN_config_drivers_audit.stderr and WCN_config_drivers_audit.stderr"
  with_items:
      - DisableFlashConfigRegistrar
      - DisableInBand802DOT11Registrar
      - DisableUPnPRegistrar
      - DisableWPDRegistrar
      - EnableRegistrars
  tags:
      - cat2
      - medium
      - audit
      - V-15698

- name: "MEDIUM | V-15698 | PATCH | The configuration of wireless devices using Windows Connect Now will be disabled."
  win_regedit:
      key: 'HKLM:\Software\Policies\Microsoft\Windows\WCN\Registrars'
      value: "{{ item }}"
      data: 0
      datatype: dword
  with_items:
      - DisableFlashConfigRegistrar
      - DisableInBand802DOT11Registrar
      - DisableUPnPRegistrar
      - DisableWPDRegistrar
      - EnableRegistrars
  tags:
      - cat2
      - medium
      - patch
      - V-15698

- name: "MEDIUM | V-15699 | AUDIT | The Windows Connect Now wizards will be disabled."
  win_command: reg query HKLM\Software\Policies\Microsoft\Windows\WCN\UI /v DisableWcnUi
  register: disable_WCN_UI_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in disable_WCN_UI_audit.stderr and disable_WCN_UI_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-15699

- name: "MEDIUM | V-15699 | PATCH | The Windows Connect Now wizards will be disabled."
  win_regedit:
    key: 'HKLM:\Software\Policies\Microsoft\Windows\WCN\UI'
    value: DisableWcnUi
    data: 1
    datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-15699

- name: "MEDIUM | V-15700 | AUDIT | Remote access to the Plug and Play interface will be disabled for device installation."
  win_command: reg query HKLM\Software\Policies\Microsoft\Windows\DeviceInstall\Settings /v AllowRemoteRPC
  register: PnP_device_install_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in PnP_device_install_audit.stderr and PnP_device_install_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-15700

- name: "MEDIUM | V-15700 | PATCH | Remote access to the Plug and Play interface will be disabled for device installation."
  win_regedit:
    key: 'HKLM:\Software\Policies\Microsoft\Windows\DeviceInstall\Settings'
    value: AllowRemoteRPC
    data: 0
    datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-15700

- name: "MEDIUM | V-15705 | AUDIT | Users will be prompted for a password on resume from sleep (on battery).  (Applicable to Server 2008 R2 if the system is configured to sleep.)"
  win_command: reg query HKLM\Software\Policies\Microsoft\Power\PowerSettings\0e796bdb-100d-47d6-a2d5-f7d2daa51f51 /v DCSettingIndex
  register: prompt_resume_DC_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in prompt_resume_DC_audit.stderr and prompt_resume_DC_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-15705

- name: "MEDIUM | V-15705 | PATCH | Users will be prompted for a password on resume from sleep (on battery).  (Applicable to Server 2008 R2 if the system is configured to sleep.)"
  win_regedit:
    key: 'HKLM:\Software\Policies\Microsoft\Power\PowerSettings\0e796bdb-100d-47d6-a2d5-f7d2daa51f51'
    value: DCSettingIndex
    data: 1
    datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-15705

- name: "MEDIUM | V-15706 | AUDIT | The user will be prompted for a password on resume from sleep (Plugged In).  (Applicable on Server 2008 R2 if the system is configured to sleep.)"
  win_command: reg query HKLM\Software\Policies\Microsoft\Power\PowerSettings\0e796bdb-100d-47d6-a2d5-f7d2daa51f51 /v ACSettingIndex
  register: prompt_resume_AC_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in prompt_resume_AC_audit.stderr and prompt_resume_AC_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-15706

- name: "MEDIUM | V-15706 | PATCH | The user will be prompted for a password on resume from sleep (Plugged In).  (Applicable on Server 2008 R2 if the system is configured to sleep.)"
  win_regedit:
    key: 'HKLM:\Software\Policies\Microsoft\Power\PowerSettings\0e796bdb-100d-47d6-a2d5-f7d2daa51f51'
    value: ACSettingIndex
    data: 1
    datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-15706

- name: "MEDIUM | V-15713 | AUDIT | Windows Defender SpyNet membership will be disabled."
  win_command: reg query \"HKLM\Software\Policies\Microsoft\Windows Defender\Spynet\" /v SpyNetReporting
  register: disable_spynet_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in disable_spynet_audit.stderr and disable_spynet_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-15713

- name: "MEDIUM | V-15713 | PATCH | Windows Defender SpyNet membership will be disabled."
  win_regedit:
    key: 'HKLM:\Software\Policies\Microsoft\Windows Defender\Spynet'
    value: SpyNetReporting
    state: absent
  tags:
      - cat2
      - medium
      - patch
      - V-15713

- name: "MEDIUM | V-15714 | AUDIT | The system must be configured to save Error Reporting events and messages to the system event log."
  win_command: reg query \"HKLM\SOFTWARE\Policies\Microsoft\Windows\Windows Error Reporting\" /v LoggingDisabled
  register: save_error_logging_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in save_error_logging_audit.stderr and save_error_logging_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-15714

- name: "MEDIUM | V-15714 | PATCH | The system must be configured to save Error Reporting events and messages to the system event log."
  win_regedit:
    key: 'HKLM:\SOFTWARE\Policies\Microsoft\Windows\Windows Error Reporting'
    value: LoggingDisabled
    data: 0
    datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-15714

- name: "MEDIUM | V-15715 | AUDIT | The system must be configured to generate error reports."
  win_command: reg query \"HKLM\SOFTWARE\Policies\Microsoft\Windows\Windows Error Reporting\" /v Disabled
  register: enable_error_logging_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in enable_error_logging_audit.stderr and enable_error_logging_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-15715

- name: "MEDIUM | V-15715 | PATCH | The system must be configured to generate error reports."
  win_regedit:
    key: 'HKLM:\SOFTWARE\Policies\Microsoft\Windows\Windows Error Reporting'
    value: Disabled
    data: 0
    datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-15715

- name: "MEDIUM | V-15722 | AUDIT | Windows Media Digital Rights Management will be prevented from accessing the Internet."
  win_command: reg query HKLM\Software\Policies\Microsoft\WMDRM /v DisableOnline
  register: DRM_online_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in DRM_online_audit.stderr and DRM_online_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-15722

- name: "MEDIUM | V-15722 | PATCH | Windows Media Digital Rights Management will be prevented from accessing the Internet."
  win_regedit:
    key: 'HKLM:\Software\Policies\Microsoft\WMDRM'
    value: DisableOnline
    data: 1
    datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-15722

- name: "MEDIUM | V-15727 | AUDIT | Users will be prevented from sharing files in their profiles."
  win_command: reg query HKCU\Software\Microsoft\Windows\CurrentVersion\Policies\Explorer /v NoInPlaceSharing
  register: sharing_files_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in sharing_files_audit.stderr and sharing_files_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-15727

- name: "MEDIUM | V-15727 | PATCH | Users will be prevented from sharing files in their profiles."
  win_regedit:
    key: 'HKCU:\Software\Microsoft\Windows\CurrentVersion\Policies\Explorer'
    value: NoInPlaceSharing
    data: 1
    datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-15727

- name: "MEDIUM | V-15823 | AUDIT | Software certificate installation files will be removed from a system."
  win_command: wmic logicaldisk get name
  register: list_of_drives_audit
  check_mode: no
  changed_when: no
  ignore_errors: yes
  tags:
      - cat2
      - medium
      - audit
      - V-15823

- name: "MEDIUM | V-15823 | AUDIT | Software certificate installation files will be removed from a system."
  win_shell: 'Get-ChildItem {{ item|trim }}\\*.p12, {{ item|trim }}\\*.pfx -recurse'
  register: certificate_installation_files_audit
  check_mode: no
  changed_when: no
  when: "'Name' not in item and item"
  with_items:
    - "{{ list_of_drives_audit.stdout_lines }}"
  tags:
      - cat2
      - medium
      - audit
      - V-15823

- name: "MEDIUM | V-15991 | AUDIT | UIAccess applications will not be allowed to prompt for elevation without using the secure desktop."
  win_command: reg query HKLM\Software\Microsoft\Windows\CurrentVersion\Policies\System /v EnableUIADesktopToggle
  register: UIA_desktop_toggle_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in UIA_desktop_toggle_audit.stderr and UIA_desktop_toggle_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-15991

- name: "MEDIUM | V-15997 | AUDIT | The system will be configured to prevent users from mapping local COM ports and redirecting data from the Remote Desktop Session Host to local COM ports. (Remote Desktop Services Role)"
  win_command: reg query \"HKLM\Software\Policies\Microsoft\Windows NT\Terminal Services\" /v fDisableCcm
  register: COM_port_redirection_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in COM_port_redirection_audit.stderr and COM_port_redirection_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-15997

- name: "MEDIUM | V-15997 | PATCH | The system will be configured to prevent users from mapping local COM ports and redirecting data from the Remote Desktop Session Host to local COM ports. (Remote Desktop Services Role)"
  win_regedit:
    key: 'HKLM:\Software\Policies\Microsoft\Windows NT\Terminal Services'
    value: fDisableCcm
    data: 1
    datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-15997

- name: "MEDIUM | V-15998 | AUDIT | The system will be configured to prevent users from mapping local LPT ports and redirecting data from the Remote Desktop Session Host to local LPT ports. (Remote Desktop Services Role)"
  win_command: reg query \"HKLM\Software\Policies\Microsoft\Windows NT\Terminal Services\" /v fDisableLPT
  register: disable_LPT_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in disable_LPT_audit.stderr and disable_LPT_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-15998

- name: "MEDIUM | V-15998 | PATCH | The system will be configured to prevent users from mapping local LPT ports and redirecting data from the Remote Desktop Session Host to local LPT ports. (Remote Desktop Services Role)"
  win_regedit:
    key: 'HKLM:\Software\Policies\Microsoft\Windows NT\Terminal Services'
    value: fDisableLPT
    data: 1
    datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-15998

- name: "MEDIUM | V-15999 | AUDIT | The system will be configured to prevent users from redirecting Plug and Play devices to the Remote Desktop Session Host. (Remote Desktop Services Role)"
  win_command: reg query \"HKLM\Software\Policies\Microsoft\Windows NT\Terminal Services\" /v fDisablePNPRedir
  register: PnP_redirect_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in PnP_redirect_audit.stderr and PnP_redirect_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-15999

- name: "MEDIUM | V-15999 | PATCH | The system will be configured to prevent users from redirecting Plug and Play devices to the Remote Desktop Session Host. (Remote Desktop Services Role)"
  win_regedit:
    key: 'HKLM:\Software\Policies\Microsoft\Windows NT\Terminal Services'
    value: fDisablePNPRedir
    data: 1
    datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-15999

- name: "MEDIUM | V-16000 | AUDIT | The system will be configured to ensure smart card devices can be redirected to the Remote Desktop Session. (Remote Desktop Services Role)"
  win_command: reg query \"HKLM\Software\Policies\Microsoft\Windows NT\Terminal Services\" /v fEnableSmartCard
  register: smart_card_redirect_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in smart_card_redirect_audit.stderr and smart_card_redirect_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-16000

- name: "MEDIUM | V-16000 | PATCH | The system will be configured to ensure smart card devices can be redirected to the Remote Desktop Session. (Remote Desktop Services Role)"
  win_regedit:
    key: 'HKLM:\Software\Policies\Microsoft\Windows NT\Terminal Services'
    value: fEnableSmartCard
    data: 1
    datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-16000

me: "MEDIUM | V-16008 | AUDIT | Windows will elevate all applications in User Account Control, not just signed ones."
  win_command: reg query HKLM\Software\Microsoft\Windows\CurrentVersion\Policies\System /v ValidateAdminCodeSignatures
  register: elevate_all_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in elevate_all_audit.stderr and elevate_all_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-16008

- name: "MEDIUM | V-16020 | AUDIT | The Windows Customer Experience Improvement Program will be disabled."
  win_command: reg query HKLM\Software\Policies\Microsoft\SQMClient\Windows /v CEIPEnable
  register: CEIP_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in CEIP_audit.stderr and CEIP_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-16020

- name: "MEDIUM | V-16020 | PATCH | The Windows Customer Experience Improvement Program will be disabled."
  win_regedit:
    key: 'HKLM:\Software\Policies\Microsoft\SQMClient\Windows'
    value: CEIPEnable
    data: 0
    datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-16020

- name: "MEDIUM | V-16021 | AUDIT | The Windows Help Experience Improvement Program will be disabled"
  win_command: reg query HKCU\Software\Policies\Microsoft\Assistance\Client\1.0 /v NoImplicitFeedback
  register: WHEIP_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in WHEIP_audit.stderr and WHEIP_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-16021

- name: "MEDIUM | V-16021 | PATCH | The Windows Help Experience Improvement Program will be disabled"
  win_regedit:
    key: 'HKCU:\Software\Policies\Microsoft\Assistance\Client\1.0'
    value: NoImplicitFeedback
    data: 1
    datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-16021

- name: "MEDIUM | V-16048 | AUDIT | Windows Help Ratings feedback will be turned off."
  win_command: reg query HKCU\Software\Policies\Microsoft\Assistance\Client\1.0 /v NoExplicitFeedback
  register: help_ratings_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in help_ratings_audit.stderr and help_ratings_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-16048

- name: "MEDIUM | V-16048 | PATCH | Windows Help Ratings feedback will be turned off."
  win_regedit:
    key: 'HKCU:\Software\Policies\Microsoft\Assistance\Client\1.0'
    value: NoExplicitFeedback
    data: 1
    datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-16048

- name: "MEDIUM | V-21950 | AUDIT | The service principal name (SPN) target name validation level will be turned off."
  win_command: reg query HKLM\System\CurrentControlSet\Services\LanmanServer\Parameters /v SmbServerNameHardeningLevel
  register: SMB_server_name_level_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in SMB_server_name_level_audit.stderr and SMB_server_name_level_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-21950

- name: "MEDIUM | V-21951 | AUDIT | Services using Local System that use negotiate when reverting to NTLM authentication will use the computer identity vs. authenticating anonymously."
  win_command: reg query HKLM\System\CurrentControlSet\Control\LSA /v UseMachineId
  register: use_machine_ID_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in use_machine_ID_audit.stderr and use_machine_ID_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-21951

- name: "MEDIUM | V-21952 | AUDIT | NTLM will be prevented from falling back to a Null session."
  win_command: reg query HKLM\System\CurrentControlSet\Control\LSA\MSV1_0 /v allownullsessionfallback
  register: null_session_fallback_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in null_session_fallback_audit.stderr and null_session_fallback_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-21952

- name: "MEDIUM | V-21952 | PATCH | NTLM will be prevented from falling back to a Null session."
  win_regedit:
    key: 'HKLM:\System\CurrentControlSet\Control\LSA\MSV1_0'
    value: allownullsessionfallback
    data: 0
    datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-21952

- name: "MEDIUM | V-21953 | AUDIT | PKU2U authentication using online identities will be prevented."
  win_command: reg query HKLM\System\CurrentControlSet\Control\LSA\pku2u /v AllowOnlineID
  register: online_ID_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in online_ID_audit.stderr and online_ID_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-21953

- name: "MEDIUM | V-21953 | PATCH | PKU2U authentication using online identities will be prevented."
  win_regedit:
    key: 'HKLM:\System\CurrentControlSet\Control\LSA\pku2u'
    value: AllowOnlineID
    data: 0
    datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-21953

- name: "MEDIUM | V-21954 | AUDIT | Kerberos encryption types must be configured to prevent the use of DES encryption suites."
  win_command: reg query HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System\Kerberos\Parameters /v SupportedEncryptionTypes
  register: kerberos_encryption_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in kerberos_encryption_audit.stderr and kerberos_encryption_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-21954

- name: "MEDIUM | V-21954 | PATCH | Kerberos encryption types must be configured to prevent the use of DES encryption suites."
  win_regedit:
    key: 'HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System\Kerberos\Parameters'
    value: SupportedEncryptionTypes
    data: 0x7ffffffc
    datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-21954


